# Tempest Weather App Implementation Plan

## Agreed Product Decisions
- Brand name: **Tempest**.
- Visual direction: **Aurora glassmorphism** with **sunrise -> dusk** palette.
- Tone: **clever but classy**.
- Units: **auto by browser locale** (frontend decides and sends to API).
- Location labeling: **enriched** (reverse geocode call is allowed).
- Dark mode: **manual toggle, no persistence** (light mode on every new visit).
- Denied location: **no manual city input**; keep single-button flow with friendly guidance.

## Architecture
1. Keep Blade-first UI on `/` and implement interactive behavior in vanilla JS.
2. Add a JSON weather endpoint at `POST /api/weather/current`.
3. Use a Form Request for server-side validation.
4. Keep controller thin; delegate provider logic and normalization to action classes in `app/Actions/Weather`.
5. Store OpenWeather secrets in config + env only; never expose API key to browser.

## Files To Modify
- `bootstrap/app.php`
  - Register API routes via `withRouting(api: __DIR__.'/../routes/api.php', ...)`.
- `routes/web.php`
  - Keep `/` page route (optionally name route for clarity/testing).
- `config/services.php`
  - Add `openweather` config (`key`, `base_url`, `timeout`).
- `.env.example`
  - Add `OPENWEATHER_API_KEY=` and optional `OPENWEATHER_BASE_URL`, `OPENWEATHER_TIMEOUT`.
- `resources/views/welcome.blade.php`
  - Replace starter content with polished Tempest page, CTA, weather card shell, status/error regions, and `noscript` fallback.
- `resources/css/app.css`
  - Add Tailwind v4 theme tokens, custom dark variant, animations, and reusable utility layers for cards/glow/background effects.
- `resources/js/app.js`
  - Implement geolocation + fetch + rendering state machine and light/dark toggle behavior (non-persistent).

## Files To Create
- `routes/api.php`
  - Define `POST /weather/current` route (under `/api` prefix automatically).
- `app/Http/Requests/Weather/FetchWeatherRequest.php`
  - Validate:
    - `latitude` numeric between `-90` and `90`
    - `longitude` numeric between `-180` and `180`
    - `units` in `metric,imperial`
  - Add custom friendly messages.
- `app/Http/Controllers/Api/Weather/ShowWeatherController.php`
  - Use validated payload and action classes; return normalized JSON.
- `app/Actions/Weather/GetCurrentWeather.php`
  - Call OpenWeather current weather endpoint with timeout/retry strategy and mapped exceptions.
- `app/Actions/Weather/GetReverseGeocodeLabel.php`
  - Call OpenWeather reverse geocode endpoint for city/state/country enrichment.
- `app/Actions/Weather/BuildWeatherSnapshot.php`
  - Normalize provider payload to one stable response shape for frontend.
- `app/Exceptions/WeatherProviderException.php`
  - Represent upstream/rate/connection failures for consistent API responses.

## API Contract
### Request
- `POST /api/weather/current`
- JSON body:
  - `latitude` (float)
  - `longitude` (float)
  - `units` (`metric` or `imperial`)

### Success (`200`)
- JSON envelope:
  - `data.location.city`
  - `data.location.region`
  - `data.location.country`
  - `data.location.label`
  - `data.weather.temperature`
  - `data.weather.feels_like`
  - `data.weather.condition`
  - `data.weather.wind_speed`
  - `data.weather.humidity`
  - `data.weather.units`
  - `data.updated_at` (ISO-8601)

### Errors
- Validation (`422`): Laravel default validation JSON.
- Rate limit (`429`): `{ "error": { "code": "weather_rate_limited", "message": "..." } }`
- Upstream failure (`502`): `{ "error": { "code": "weather_upstream_error", "message": "..." } }`
- Connection timeout/failure (`503`): `{ "error": { "code": "weather_connection_error", "message": "..." } }`

## Frontend UX + State Model
1. Initial state: hero copy + large `Get my weather` button + hidden weather card.
2. Click CTA -> request geolocation.
3. On coordinates success -> call `/api/weather/current` and show loading state.
4. On success -> animate in weather card with polished metrics and updated timestamp.
5. On failure -> show friendly, specific message:
   - Browser geolocation unsupported
   - Permission denied
   - Position unavailable/timeout
   - API validation error
   - API rate limited / upstream down / network issue
6. Dark mode toggle:
   - Light default on page load.
   - Toggle adds/removes `dark` on `<html>`.
   - No localStorage persistence.
7. Progressive enhancement:
   - Add `noscript` panel explaining that location-based weather requires JavaScript.

## Visual/Accessibility Plan
- Use sunrise-tinted light theme and deep dusk dark theme with matching contrast-safe tokens.
- Build layered atmospheric background (gradients + glow blobs + subtle grain) while preserving text legibility.
- Add meaningful animations only:
  - page reveal sequence
  - CTA hover/press states
  - weather card entrance
  - gentle icon/ambient motion
- Mobile-first layout:
  - unprefixed classes for mobile
  - scale typography/cards at `sm/md/lg`
  - large tap targets and spacing
- Accessibility:
  - maintain AA contrast in both modes
  - use `aria-live="polite"` for status updates
  - preserve visible focus styles for keyboard navigation

## Testing Plan (High Coverage, No Browser Tests)
### Feature tests
- `tests/Feature/Weather/ShowWeatherTest.php`
  - returns normalized weather payload for valid coordinates
  - validates missing/invalid `latitude`
  - validates missing/invalid `longitude`
  - validates invalid `units`
  - maps provider `429` to app `429` error shape
  - maps provider `5xx` to app `502` error shape
  - maps connection exception to app `503` error shape
  - verifies both weather and reverse-geocode calls are made (using `Http::fake` assertions)

- `tests/Feature/Homepage/WelcomePageTest.php`
  - homepage loads (`200`)
  - includes Tempest CTA and `noscript` guidance

### Unit tests
- `tests/Unit/Actions/Weather/GetCurrentWeatherTest.php`
  - parses expected fields from provider response
  - throws domain exception on failed upstream response

- `tests/Unit/Actions/Weather/GetReverseGeocodeLabelTest.php`
  - formats enriched location label from reverse geocode response
  - falls back gracefully when region/state is missing

- `tests/Unit/Actions/Weather/BuildWeatherSnapshotTest.php`
  - outputs stable response structure and units
  - includes ISO timestamp and fallback values when optional data is absent

## Implementation Sequence
1. Add API routing and OpenWeather config/env plumbing.
2. Build request validation + controller skeleton.
3. Implement weather action classes + custom exception mapping.
4. Implement polished Blade markup and Tailwind theme/animation tokens.
5. Implement vanilla JS state machine, geolocation flow, API fetch, rendering, and error UI.
6. Write feature + unit tests with `Http::fake` coverage for success/failure scenarios.
7. Run formatter and tests; fix any edge cases.

## Verification
1. Format code:
   - `ddev exec vendor/bin/pint --dirty --format agent`
2. Run tests:
   - `ddev artisan test --compact`
   - Optional focused runs during iteration:
     - `ddev artisan test --compact tests/Feature/Weather/ShowWeatherTest.php`
     - `ddev artisan test --compact tests/Unit/Actions/Weather`
3. Manual check in browser:
   - Home page renders polished light theme by default.
   - Theme toggle switches to dark and back (resets to light on refresh).
   - Geolocation success renders weather card.
   - Denied/unsupported geolocation shows friendly error.
   - API failure scenarios render graceful error states.
